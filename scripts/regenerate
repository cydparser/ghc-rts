#!/usr/bin/env bash
set -eo pipefail

cd "$(dirname "${BASH_SOURCE[0]}")/.." || exit 1

_files=(
  "src/rts/adjustor/tests.rs"
  "src/rts/adjustor.rs"
  "src/rts/block_signals/tests.rs"
  "src/rts/block_signals.rs"
  "src/rts/config/tests.rs"
  "src/rts/config.rs"
  "src/rts/constants/tests.rs"
  "src/rts/constants.rs"
  "src/rts/event_log_writer/tests.rs"
  "src/rts/event_log_writer.rs"
  "src/rts/exec_page/tests.rs"
  "src/rts/exec_page.rs"
  "src/rts/file_lock/tests.rs"
  "src/rts/file_lock.rs"
  "src/rts/flags/tests.rs"
  "src/rts/flags.rs"
  "src/rts/foreign_exports/tests.rs"
  "src/rts/foreign_exports.rs"
  "src/rts/get_time/tests.rs"
  "src/rts/get_time.rs"
  "src/rts/globals/tests.rs"
  "src/rts/globals.rs"
  "src/rts/hpc/tests.rs"
  "src/rts/hpc.rs"
  "src/rts/io_interface/tests.rs"
  "src/rts/io_interface.rs"
  "src/rts/ipe/tests.rs"
  "src/rts/ipe.rs"
  "src/rts/libdw/tests.rs"
  "src/rts/libdw.rs"
  "src/rts/libdw_pool/tests.rs"
  "src/rts/libdw_pool.rs"
  "src/rts/linker/tests.rs"
  "src/rts/linker.rs"
  "src/rts/main/tests.rs"
  "src/rts/main.rs"
  "src/rts/messages/tests.rs"
  "src/rts/messages.rs"
  "src/rts/non_moving/tests.rs"
  "src/rts/non_moving.rs"
  "src/rts/os_threads/tests.rs"
  "src/rts/os_threads.rs"
  "src/rts/parallel/tests.rs"
  "src/rts/parallel.rs"
  "src/rts/prim_float/tests.rs"
  "src/rts/prim_float.rs"
  "src/rts/prof/heap/tests.rs"
  "src/rts/prof/heap.rs"
  "src/rts/prof/ldv/tests.rs"
  "src/rts/prof/ldv.rs"
  "src/rts/profiling/tests.rs"
  "src/rts/profiling.rs"
  "src/rts/signals/tests.rs"
  "src/rts/signals.rs"
  "src/rts/spin_lock/tests.rs"
  "src/rts/spin_lock.rs"
  "src/rts/stable_name/tests.rs"
  "src/rts/stable_name.rs"
  "src/rts/stable_ptr/tests.rs"
  "src/rts/stable_ptr.rs"
  "src/rts/static_ptr_table/tests.rs"
  "src/rts/static_ptr_table.rs"
  "src/rts/storage/closure_macros/tests.rs"
  "src/rts/storage/closure_macros.rs"
  "src/rts/storage/closure_types/tests.rs"
  "src/rts/storage/closure_types.rs"
  "src/rts/storage/closures/tests.rs"
  "src/rts/storage/closures.rs"
  "src/rts/storage/fun_types/tests.rs"
  "src/rts/storage/fun_types.rs"
  "src/rts/storage/gc/tests.rs"
  "src/rts/storage/gc.rs"
  "src/rts/storage/heap/tests.rs"
  "src/rts/storage/heap.rs"
  "src/rts/storage/m_block/tests.rs"
  "src/rts/storage/m_block.rs"
  "src/rts/threads/tests.rs"
  "src/rts/threads.rs"
  "src/rts/ticky/tests.rs"
  "src/rts/ticky.rs"
  "src/rts/time/tests.rs"
  "src/rts/time.rs"
  "src/rts/timer/tests.rs"
  "src/rts/timer.rs"
  "src/rts/tsan_utils/tests.rs"
  "src/rts/tsan_utils.rs"
  "src/rts/tty/tests.rs"
  "src/rts/tty.rs"
  "src/rts/utils/tests.rs"
  "src/rts/utils.rs"
  "src/rts_api/tests.rs"
  "src/rts_api.rs"
  "src/stg/dll/tests.rs"
  "src/stg/dll.rs"
  "src/stg/mach_regs_for_host/tests.rs"
  "src/stg/mach_regs_for_host.rs"
  "src/stg/misc_closures/tests.rs"
  "src/stg/misc_closures.rs"
  "src/stg/prim/tests.rs"
  "src/stg/prim.rs"
  "src/stg/smp/tests.rs"
  "src/stg/smp.rs"
  "src/stg/tests.rs"
  "src/stg/ticky/tests.rs"
  "src/stg/ticky.rs"
)

rm -f "${_files[@]}"

cargo run -p generate src

sed -i \
  -e 's/::core::option:://g' \
  -e 's/::core::ffi:://g' \
  -e 's/::core::slice::/slice::/g' \
  "${_files[@]}"
